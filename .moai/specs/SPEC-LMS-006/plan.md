# SPEC-LMS-006: Implementation Plan

## Metadata

| Field   | Value          |
| ------- | -------------- |
| SPEC ID | SPEC-LMS-006   |
| Title   | LMS Gamification System - Implementation Plan |
| Status  | Planned        |

---

## Implementation Strategy

The gamification system is implemented in 4 TAGs (incremental milestones). Each TAG builds on the previous one. The dependency graph is strictly linear: TAG-001 must complete before TAG-002, TAG-002 before TAG-003, and TAG-003 before TAG-004.

### Development Methodology

- **Mode**: DDD (ANALYZE-PRESERVE-IMPROVE) per `quality.yaml`
- **Pattern**: Pure utility functions (no side effects) for all calculation logic, following `gradeUtils.ts` and `lmsAnalyticsUtils.ts` patterns
- **Testing**: Characterization tests for modified Server Actions, specification tests for new gamification logic
- **Atomic writes**: All XP/badge/streak updates wrapped in `prisma.$transaction`

---

## TAG-001: Schema, Utilities, and Seed Data

**Priority**: Primary Goal (foundation for all subsequent TAGs)

### Objective

Establish the data layer and pure business logic for the gamification system.

### Files to Create

| File | Type | Description |
| ---- | ---- | ----------- |
| `prisma/migrations/XXXXXX_add_gamification/migration.sql` | Migration | Auto-generated by `prisma migrate dev` |
| `src/lib/gamificationUtils.ts` | Utility | Pure functions: XP calculation, streak evaluation, badge eligibility, level computation |

### Files to Modify

| File | Change Description |
| ---- | ------------------ |
| `prisma/schema.prisma` | Add 4 new models (`StudentGamification`, `Badge`, `StudentBadge`, `XpTransaction`), 1 new enum (`XpSource`), extend `NotificationType` with `GAMIFICATION`, add new relations on `Student` model |
| `prisma/seed.ts` | Add seed data for 10 default badges |
| `src/lib/formValidationSchemas.ts` | Add Zod schema for `Badge` creation/update form |

### gamificationUtils.ts Function Signatures

```typescript
// XP Configuration Constants
export const XP_LESSON_COMPLETE = 10;
export const XP_QUIZ_SUBMIT = 15;
export const XP_QUIZ_PASS = 25;
export const XP_QUIZ_PERFECT = 50;
export const XP_DAILY_STREAK = 5;
export const XP_STREAK_7_BONUS = 30;
export const XP_COURSE_COMPLETE = 100;

// Level Thresholds
export const LEVEL_THRESHOLDS: readonly number[] = [0, 50, 150, 300, 500, 750, 1050, 1400, 1800, 2250];

// Pure Functions
export function computeLevel(totalXp: number): number;
export function computeLevelProgress(totalXp: number): { level: number; currentXp: number; nextLevelXp: number; percentage: number };
export function computeQuizXp(percentage: number, passScore: number): number;
export function evaluateStreak(lastActivityDate: Date | null, today: Date, currentStreak: number): { newStreak: number; streakIncremented: boolean; isNewDay: boolean };
export function evaluateBadgeEligibility(category: string, value: number, existingBadgeIds: number[], allBadges: Badge[]): Badge[];
export function computeLeaderboardRanking(students: StudentGamificationData[]): RankedStudent[];
export function computeWeeklyXp(transactions: XpTransactionData[], weekStart: Date): number;
```

### Acceptance Gate

- Prisma migration applies without errors
- All `gamificationUtils.ts` functions are pure (no imports from Prisma or server modules)
- Seed script creates 10 default badges
- Zod schema validates badge form input

---

## TAG-002: XP and Streak Engine (Server Action Integration)

**Priority**: Primary Goal (core game mechanics)

### Objective

Wire the gamification trigger mechanism into existing Server Actions so that XP, streaks, and badges are awarded automatically on qualifying events.

### Files to Create

| File | Type | Description |
| ---- | ---- | ----------- |
| `src/lib/gamificationActions.ts` | Server Actions | `processGamificationEvent`, `awardXp`, `checkAndAwardBadges`, `createBadge`, `updateBadge`, `deleteBadge` |

### Files to Modify

| File | Change Description |
| ---- | ------------------ |
| `src/lib/actions.ts` | Add `processGamificationEvent` call after lesson completion (`markLessonComplete` or equivalent) and quiz submission actions. Add course completion detection after lesson complete. |
| `src/lib/notificationActions.ts` | No structural change needed; `createNotification` already accepts `NotificationType` which now includes `GAMIFICATION` |

### processGamificationEvent Flow

```
processGamificationEvent(studentId, eventType, eventData)
  |
  +-- prisma.$transaction:
  |     |
  |     +-- Upsert StudentGamification (get-or-create)
  |     +-- Calculate XP for event type
  |     +-- Create XpTransaction record
  |     +-- Increment totalXp on StudentGamification
  |     +-- Evaluate streak (if new day)
  |     |     +-- Award streak XP if incremented
  |     |     +-- Check streak badge thresholds
  |     +-- Check for level-up
  |     +-- Evaluate badge eligibility for event category
  |     +-- Create StudentBadge records for earned badges
  |     +-- Create XpTransaction records for badge XP rewards
  |     +-- Update totalXp with badge rewards
  |     +-- Re-check level after badge XP
  |
  +-- Post-transaction (outside $transaction):
        +-- Create notifications for badges earned
        +-- Create notification for level-up (if occurred)
```

### Integration Points

1. **Lesson completion**: After the existing action writes `LessonProgress` with `COMPLETED` status, call `processGamificationEvent(studentId, 'LESSON_COMPLETE', { lessonId })`.
2. **Quiz submission**: After the existing action writes `QuizAttempt` with score, call `processGamificationEvent(studentId, 'QUIZ_SUBMIT', { quizId, percentage, passed })`.
3. **Course completion**: Inside `processGamificationEvent` for `LESSON_COMPLETE`, check if all lessons in the course are now completed. If so, award course completion XP.

### Acceptance Gate

- Completing a lesson awards 10 XP and creates an `XpTransaction`
- Submitting a quiz awards tiered XP (15/25/50) based on score
- Streak increments on new activity day, resets after gap > 1 day
- Badges are awarded exactly once (duplicate attempt gracefully ignored)
- Level-up occurs at correct thresholds
- Notifications created for badge awards and level-ups
- All writes atomic via `prisma.$transaction`

---

## TAG-003: Student Dashboard and Achievements Page

**Priority**: Secondary Goal (user-facing UI)

### Objective

Build the student-facing gamification UI: dashboard widgets and the full achievements page.

### Files to Create

| File | Type | Description |
| ---- | ---- | ----------- |
| `src/components/GamificationCard.tsx` | Client Component | Compact card: level, XP, progress bar, streak |
| `src/components/GamificationCardContainer.tsx` | Server Component | Fetches `StudentGamification` data for the card |
| `src/components/RecentBadges.tsx` | Client Component | Displays 3 most recently earned badges |
| `src/components/RecentBadgesContainer.tsx` | Server Component | Fetches last 3 `StudentBadge` records |
| `src/components/BadgeGallery.tsx` | Client Component | Full badge grid (earned vs locked) |
| `src/components/XpTransactionHistory.tsx` | Client Component | Paginated XP transaction list |
| `src/components/StreakCalendar.tsx` | Client Component | Calendar heatmap showing streak/activity days |
| `src/components/LevelProgressBar.tsx` | Client Component | Level progress visualization |
| `src/app/(dashboard)/list/achievements/page.tsx` | Page | Full achievements page |

### Files to Modify

| File | Change Description |
| ---- | ------------------ |
| `src/app/(dashboard)/student/page.tsx` | Add `GamificationCardContainer` and `RecentBadgesContainer` to right sidebar, add link to achievements page |
| `src/lib/settings.ts` | Add `/list/achievements` to `routeAccessMap` for student role |
| `src/components/Menu.tsx` | Add "Achievements" menu item under LMS section for student role |

### Component Specifications

**GamificationCard**:
- Shows: Level badge (circular), "Level N" label, XP count, progress bar (percentage to next level), flame icon with current streak, "Longest: N days" subtitle
- Color: Progress bar follows green/yellow/red convention based on level progress percentage
- Size: Fits within the existing right sidebar column width

**RecentBadges**:
- Shows: 3 badge icons with names and earned dates
- Locked state: "View all" link to achievements page
- Empty state: "No badges earned yet. Start learning!"

**Achievements Page Layout**:
- Top section: Level progress visualization (large progress bar with level milestones)
- Middle section: Badge gallery (grid of badge cards, earned in color, locked grayed out with lock icon)
- Bottom section: XP transaction history (table with date, source, amount, running total)
- Sidebar: Streak calendar (similar to GitHub contribution calendar)

### Acceptance Gate

- GamificationCard renders correctly with mock data (level, XP, streak)
- RecentBadges shows earned badges or empty state
- Achievements page loads with all four sections
- Navigation from dashboard to achievements page works
- Streak calendar renders activity days accurately
- Page is accessible at `/list/achievements` for student role only

---

## TAG-004: Leaderboard, Parent Dashboard, and Admin Integration

**Priority**: Secondary Goal (cross-role features)

### Objective

Add leaderboard functionality, parent gamification visibility, and admin adoption metrics.

### Files to Create

| File | Type | Description |
| ---- | ---- | ----------- |
| `src/components/ClassLeaderboard.tsx` | Client Component | Ranked student list with XP, weekly/all-time toggle |
| `src/components/ClassLeaderboardContainer.tsx` | Server Component | Fetches gamification data for class |
| `src/components/ChildGamificationStats.tsx` | Client Component | Per-child gamification summary for parent |
| `src/components/GamificationAdoptionMetrics.tsx` | Server Component | Admin school-wide gamification stats |
| `src/components/forms/BadgeForm.tsx` | Client Component | Admin badge create/update form |

### Files to Modify

| File | Change Description |
| ---- | ------------------ |
| `src/app/(dashboard)/teacher/page.tsx` | Add `ClassLeaderboardContainer` as optional widget (based on teacher preference) |
| `src/app/(dashboard)/parent/page.tsx` | Add `ChildGamificationStats` to each child's data section |
| `src/app/(dashboard)/admin/page.tsx` | Add `GamificationAdoptionMetrics` to admin dashboard |
| `src/components/FormContainer.tsx` | Add `badge` case to form resolver for admin badge management |
| `src/lib/actions.ts` or `src/lib/gamificationActions.ts` | Ensure `createBadge`, `updateBadge`, `deleteBadge` Server Actions exist |
| `src/lib/settings.ts` | Add leaderboard toggle preference, add badge management route access |
| `src/components/Menu.tsx` | Add "Badges" menu item for admin role |

### Leaderboard Specifications

**ClassLeaderboard**:
- Toggle: "This Week" / "All Time" tabs
- Columns: Rank, Student Name (or "Student #N" in anonymous mode), Level, XP
- Top 3: Highlighted with gold/silver/bronze accent
- Anonymous mode: Teacher configurable via a setting (stored as a simple JSON config or a new field)
- Pagination: 50 students per page

**Leaderboard Enable/Disable**:
- Teachers can enable/disable leaderboard per class via a toggle
- Implementation: A simple JSON field or a new `ClassGamificationConfig` model (lightweight approach recommended: store as a JSON field on `Class` or as a separate settings table)

### Parent Integration

**ChildGamificationStats**:
- Displays within existing parent dashboard child section
- Shows: Level indicator, total XP, current streak, latest badge earned
- Compact layout matching existing `ChildQuickStats` / `ChildLmsProgressCard` style

### Admin Integration

**GamificationAdoptionMetrics**:
- Cards: "Active Streaks" (students with streak > 0), "Avg XP" (mean totalXp), "Badges Awarded" (count of StudentBadge records)
- Follows existing admin dashboard metric card pattern

**BadgeForm**:
- Fields: Name, Description, Icon URL, Category (dropdown), Threshold (number), XP Reward (number)
- Validation: Zod schema from TAG-001
- Pattern: Follows existing entity form pattern in `src/components/forms/`

### Acceptance Gate

- Leaderboard displays correct ranking for weekly and all-time views
- Anonymous mode hides student names
- Teacher can enable/disable leaderboard
- Parent sees gamification data for each child
- Admin sees adoption metrics
- Admin can create, update, and delete badges via form

---

## Dependency Graph

```
TAG-001 (Schema + Utils + Seed)
    |
    v
TAG-002 (XP/Streak Engine + Server Action Hooks)
    |
    v
TAG-003 (Student Dashboard + Achievements Page)
    |
    v
TAG-004 (Leaderboard + Parent + Admin)
```

All TAGs are strictly sequential. TAG-002 depends on the models and utilities from TAG-001. TAG-003 depends on data being generated by TAG-002. TAG-004 depends on all prior TAGs for data availability and component patterns.

---

## Risk Assessment

### Risk 1: Transaction Complexity

**Description**: The `processGamificationEvent` function performs multiple dependent writes (XP, streak, badges, level) inside a single `prisma.$transaction`. Complex transactions can fail or deadlock.

**Likelihood**: Medium

**Impact**: High (partial gamification state)

**Mitigation**: Follow the existing quiz submission pattern which already uses `prisma.$transaction` with multiple writes. Keep the transaction scope narrow. Use sequential operations within the transaction (no nested transactions). Add error logging with meaningful context.

### Risk 2: Streak Edge Cases with Timezones

**Description**: Students may be in different timezones. Using UTC for day boundaries means a student active at 11:55 PM local time and 12:05 AM local time (same session) could register as two different UTC days or miss a streak.

**Likelihood**: Medium

**Impact**: Low (minor UX frustration)

**Mitigation**: Document that streaks use UTC calendar days consistently. This is acceptable for a school with under 500 users in a single region. If timezone support is needed later, `lastActivityDate` can be migrated to store a timezone-aware date.

### Risk 3: Duplicate Badge Award Race Condition

**Description**: If two qualifying events fire simultaneously for the same student, both could attempt to award the same badge before the unique constraint check in the application layer.

**Likelihood**: Low (under 500 users, single-user actions)

**Impact**: Low (database unique constraint catches the duplicate)

**Mitigation**: The `@@unique([studentId, badgeId])` constraint on `StudentBadge` prevents duplicate inserts at the database level. The application code should catch the unique constraint violation gracefully and continue without error.

### Risk 4: Large Seed Data for Badges

**Description**: If the seed script is re-run, it could fail due to duplicate badge names or create duplicate badges.

**Likelihood**: Medium

**Impact**: Low (development environment only)

**Mitigation**: Use `upsert` in the seed script to handle re-runs gracefully. Match on badge `name` (or a unique slug field if added).

### Risk 5: Student Model Relation Bloat

**Description**: Adding 3 new relations (`gamification`, `badges`, `xpTransactions`) to the `Student` model increases its relation count. This could affect query performance if Student queries include too many eager loads.

**Likelihood**: Low

**Impact**: Low (gamification data only loaded when needed)

**Mitigation**: Never include gamification relations in default Student queries. Only load gamification data explicitly when rendering gamification-specific components. Use `select` and `include` precisely in Prisma queries.

---

## Expert Consultation Recommendations

### Backend Expert (expert-backend)

Recommended for TAG-002 implementation. The `processGamificationEvent` function involves:
- Complex `prisma.$transaction` with multiple dependent writes
- Integration with existing Server Actions without breaking them
- Race condition handling for badge deduplication
- Notification creation flow

### Frontend Expert (expert-frontend)

Recommended for TAG-003 and TAG-004 implementation. The UI work involves:
- Gamification card with progress bar and streak animation
- Badge gallery with locked/unlocked states
- Leaderboard with toggle and pagination
- Streak calendar (similar to GitHub contribution heatmap)
- Integration with existing dashboard layouts

---

## File Summary

### New Files (17)

| File | TAG |
| ---- | --- |
| `prisma/migrations/XXXXXX_add_gamification/migration.sql` | TAG-001 |
| `src/lib/gamificationUtils.ts` | TAG-001 |
| `src/lib/gamificationActions.ts` | TAG-002 |
| `src/components/GamificationCard.tsx` | TAG-003 |
| `src/components/GamificationCardContainer.tsx` | TAG-003 |
| `src/components/RecentBadges.tsx` | TAG-003 |
| `src/components/RecentBadgesContainer.tsx` | TAG-003 |
| `src/components/BadgeGallery.tsx` | TAG-003 |
| `src/components/XpTransactionHistory.tsx` | TAG-003 |
| `src/components/StreakCalendar.tsx` | TAG-003 |
| `src/components/LevelProgressBar.tsx` | TAG-003 |
| `src/app/(dashboard)/list/achievements/page.tsx` | TAG-003 |
| `src/components/ClassLeaderboard.tsx` | TAG-004 |
| `src/components/ClassLeaderboardContainer.tsx` | TAG-004 |
| `src/components/ChildGamificationStats.tsx` | TAG-004 |
| `src/components/GamificationAdoptionMetrics.tsx` | TAG-004 |
| `src/components/forms/BadgeForm.tsx` | TAG-004 |

### Modified Files (10)

| File | TAG(s) |
| ---- | ------ |
| `prisma/schema.prisma` | TAG-001 |
| `prisma/seed.ts` | TAG-001 |
| `src/lib/formValidationSchemas.ts` | TAG-001 |
| `src/lib/actions.ts` | TAG-002 |
| `src/app/(dashboard)/student/page.tsx` | TAG-003 |
| `src/lib/settings.ts` | TAG-003, TAG-004 |
| `src/components/Menu.tsx` | TAG-003, TAG-004 |
| `src/app/(dashboard)/teacher/page.tsx` | TAG-004 |
| `src/app/(dashboard)/parent/page.tsx` | TAG-004 |
| `src/app/(dashboard)/admin/page.tsx` | TAG-004 |
| `src/components/FormContainer.tsx` | TAG-004 |
