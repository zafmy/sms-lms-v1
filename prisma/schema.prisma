generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id       String @id
  username String @unique
}

model Student {
  id              String           @id
  username        String           @unique
  name            String
  surname         String
  email           String?          @unique
  phone           String?          @unique
  address         String
  img             String?
  bloodType       String
  sex             UserSex
  createdAt       DateTime         @default(now())
  parentId        String
  parent          Parent           @relation(fields: [parentId], references: [id])
  classId         Int
  class           Class            @relation(fields: [classId], references: [id])
  gradeId         Int
  grade           Grade            @relation(fields: [gradeId], references: [id])
  attendances     Attendance[]
  results         Result[]
  birthday        DateTime
  enrollments     Enrollment[]
  lessonProgress  LessonProgress[]
  quizAttempts    QuizAttempt[]
  gamification    StudentGamification?
  badges          StudentBadge[]
  xpTransactions  XpTransaction[]
  reviewCards     ReviewCard[]
  reviewLogs      ReviewLog[]
  reviewSessions  ReviewSession[]
}

model Teacher {
  id            String         @id
  username      String         @unique
  name          String
  surname       String
  email         String?        @unique
  phone         String?        @unique
  address       String
  img           String?
  bloodType     String
  sex           UserSex
  createdAt     DateTime       @default(now())
  subjects      Subject[]
  lessons       Lesson[]
  classes       Class[]
  birthday      DateTime
  courses       Course[]
  questionBanks QuestionBank[]
}

model Parent {
  id        String    @id
  username  String    @unique
  name      String
  surname   String
  email     String?   @unique
  phone     String    @unique
  address   String
  createdAt DateTime  @default(now())
  students  Student[]
}

model Grade {
  id    Int @id @default(autoincrement())
  level Int @unique

  students Student[]
  classes  Class[]
}

model Class {
  id       Int    @id @default(autoincrement())
  name     String @unique
  capacity Int

  supervisorId  String?
  supervisor    Teacher?       @relation(fields: [supervisorId], references: [id])
  lessons       Lesson[]
  students      Student[]
  gradeId       Int
  grade         Grade          @relation(fields: [gradeId], references: [id])
  events        Event[]
  announcements Announcement[]
}

model Subject {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  teachers      Teacher[]
  lessons       Lesson[]
  courses       Course[]
  questionBanks QuestionBank[]
  reviewCards   ReviewCard[]
}

model Lesson {
  id        Int      @id @default(autoincrement())
  name      String
  day       Day
  startTime DateTime
  endTime   DateTime

  subjectId   Int
  subject     Subject      @relation(fields: [subjectId], references: [id])
  classId     Int
  class       Class        @relation(fields: [classId], references: [id])
  teacherId   String
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  exams       Exam[]
  assignments Assignment[]
  attendances Attendance[]
}

model Exam {
  id        Int      @id @default(autoincrement())
  title     String
  startTime DateTime
  endTime   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Assignment {
  id        Int      @id @default(autoincrement())
  title     String
  startDate DateTime
  dueDate   DateTime

  lessonId Int
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  results  Result[]
}

model Result {
  id    Int @id @default(autoincrement())
  score Int

  examId       Int?
  exam         Exam?       @relation(fields: [examId], references: [id])
  assignmentId Int?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  studentId    String
  student      Student     @relation(fields: [studentId], references: [id])
}

model Attendance {
  id      Int      @id @default(autoincrement())
  date    DateTime
  present Boolean

  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  lessonId  Int
  lesson    Lesson  @relation(fields: [lessonId], references: [id])
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  startTime   DateTime
  endTime     DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

model Announcement {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  date        DateTime

  classId Int?
  class   Class? @relation(fields: [classId], references: [id])
}

model Notification {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  message   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  userId String
}

enum NotificationType {
  GRADE
  ATTENDANCE
  ANNOUNCEMENT
  ASSIGNMENT
  GENERAL
  ENROLLMENT
  GAMIFICATION
  REVIEW
}

enum UserSex {
  MALE
  FEMALE
}

enum Day {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum CourseStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ContentType {
  TEXT
  VIDEO
  LINK
  MIXED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_BLANK
}

enum ScoringPolicy {
  BEST
  LATEST
  AVERAGE
}

model Course {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  code        String       @unique
  status         CourseStatus @default(DRAFT)
  maxEnrollments Int?
  createdAt      DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  teacherId   String
  teacher     Teacher      @relation(fields: [teacherId], references: [id])
  subjectId   Int
  subject     Subject      @relation(fields: [subjectId], references: [id])
  modules     Module[]
  enrollments Enrollment[]
  reviewCards ReviewCard[]
}

model Module {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  order       Int
  isLocked    Boolean  @default(false)
  courseId     Int
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     LmsLesson[]
}

model LmsLesson {
  id               Int             @id @default(autoincrement())
  title            String
  content          String
  contentType      ContentType     @default(TEXT)
  externalUrl      String?
  order            Int
  estimatedMinutes Int?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  flagForReview    Boolean         @default(false)
  moduleId         Int
  module           Module          @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quizzes          Quiz[]
  progress         LessonProgress[]
  reviewCards      ReviewCard[]
}

model LessonProgress {
  id               Int            @id @default(autoincrement())
  status           ProgressStatus @default(NOT_STARTED)
  startedAt        DateTime?
  completedAt      DateTime?
  timeSpentSeconds Int            @default(0)
  studentId        String
  student          Student        @relation(fields: [studentId], references: [id])
  lessonId         Int
  lesson           LmsLesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
}

model Enrollment {
  id         Int              @id @default(autoincrement())
  enrolledAt DateTime         @default(now())
  status     EnrollmentStatus @default(ACTIVE)
  studentId  String
  student    Student          @relation(fields: [studentId], references: [id])
  courseId   Int
  course     Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
}

model Quiz {
  id                 Int           @id @default(autoincrement())
  title              String
  description        String?
  timeLimit          Int?
  maxAttempts        Int           @default(1)
  passScore          Int           @default(70)
  scoringPolicy      ScoringPolicy @default(BEST)
  randomizeQuestions Boolean       @default(false)
  randomizeOptions   Boolean       @default(false)
  createdAt          DateTime      @default(now())
  lessonId           Int
  lesson             LmsLesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions          Question[]
  attempts           QuizAttempt[]
}

model Question {
  id             Int               @id @default(autoincrement())
  text           String
  type           QuestionType
  explanation    String?
  points         Int               @default(1)
  order          Int
  quizId         Int?
  quiz           Quiz?             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  questionBankId Int?
  questionBank   QuestionBank?     @relation(fields: [questionBankId], references: [id])
  options        AnswerOption[]
  responses      QuestionResponse[]
  reviewCards    ReviewCard[]
}

model QuestionBank {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  subjectId   Int
  subject     Subject    @relation(fields: [subjectId], references: [id])
  teacherId   String
  teacher     Teacher    @relation(fields: [teacherId], references: [id])
  createdAt   DateTime   @default(now())
  questions   Question[]
}

model AnswerOption {
  id         Int      @id @default(autoincrement())
  text       String
  isCorrect  Boolean
  order      Int
  questionId Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id            Int                @id @default(autoincrement())
  attemptNumber Int
  startedAt     DateTime           @default(now())
  submittedAt   DateTime?
  score         Int?
  maxScore      Int?
  percentage    Float?
  passed        Boolean?
  studentId     String
  student       Student            @relation(fields: [studentId], references: [id])
  quizId        Int
  quiz          Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)
  responses     QuestionResponse[]
}

model QuestionResponse {
  id               Int          @id @default(autoincrement())
  selectedOptionId Int?
  textResponse     String?
  isCorrect        Boolean?
  pointsEarned     Int          @default(0)
  timeTakenSeconds Int?
  questionId       Int
  question         Question     @relation(fields: [questionId], references: [id])
  attemptId        Int
  attempt          QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
}

enum ReviewCardType {
  QUIZ_QUESTION
  VOCABULARY
  CONCEPT
  FLASHCARD
}

enum ReviewRating {
  HARD
  OK
  EASY
}

enum XpSource {
  LESSON
  QUIZ
  STREAK
  BADGE
  MANUAL
  REVIEW
}

model StudentGamification {
  id               Int       @id @default(autoincrement())
  studentId        String    @unique
  totalXp          Int       @default(0)
  currentLevel     Int       @default(1)
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  lastActivityDate DateTime?
  student          Student   @relation(fields: [studentId], references: [id])
}

model Badge {
  id          Int            @id @default(autoincrement())
  name        String         @unique
  description String
  iconUrl     String?
  criteria    String
  xpReward    Int            @default(0)
  category    String
  threshold   Int?
  createdAt   DateTime       @default(now())
  students    StudentBadge[]
}

model StudentBadge {
  id        Int      @id @default(autoincrement())
  studentId String
  badgeId   Int
  earnedAt  DateTime @default(now())
  student   Student  @relation(fields: [studentId], references: [id])
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([studentId, badgeId])
}

model XpTransaction {
  id        Int      @id @default(autoincrement())
  studentId String
  amount    Int
  source    XpSource
  sourceId  String?
  createdAt DateTime @default(now())
  student   Student  @relation(fields: [studentId], references: [id])
}

model ReviewCard {
  id                 Int            @id @default(autoincrement())
  studentId          String
  student            Student        @relation(fields: [studentId], references: [id])
  courseId            Int
  course             Course         @relation(fields: [courseId], references: [id])
  subjectId          Int
  subject            Subject        @relation(fields: [subjectId], references: [id])
  cardType           ReviewCardType
  front              String
  back               String
  sourceQuestionId   Int?
  sourceQuestion     Question?      @relation(fields: [sourceQuestionId], references: [id])
  sourceLessonId     Int?
  sourceLesson       LmsLesson?     @relation(fields: [sourceLessonId], references: [id])
  leitnerBox         Int            @default(1)
  easinessFactor     Float          @default(2.5)
  consecutiveCorrect Int            @default(0)
  nextReviewDate     DateTime
  lastReviewedAt     DateTime?
  reviewCount        Int            @default(0)
  stability          Float?
  difficulty         Float?
  retrievability     Float?
  isActive           Boolean        @default(true)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  reviewLogs         ReviewLog[]

  @@index([studentId, isActive, nextReviewDate])
  @@index([studentId, sourceQuestionId])
}

model ReviewLog {
  id             Int          @id @default(autoincrement())
  reviewCardId   Int
  reviewCard     ReviewCard   @relation(fields: [reviewCardId], references: [id], onDelete: Cascade)
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  rating         ReviewRating
  previousBox    Int
  newBox         Int
  previousEF     Float
  newEF          Float
  responseTimeMs Int?
  reviewedAt     DateTime     @default(now())

  @@index([studentId, reviewedAt])
  @@index([reviewCardId])
}

model ReviewSession {
  id           Int       @id @default(autoincrement())
  studentId    String
  student      Student   @relation(fields: [studentId], references: [id])
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  totalCards   Int
  correctCards Int       @default(0)
  xpEarned     Int       @default(0)

  @@index([studentId, startedAt])
}
